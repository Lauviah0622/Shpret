var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,o=(e,t)=>{for(var n in t||(t={}))a.call(t,n)&&s(e,n,t[n]);if(r)for(var n of r(t))l.call(t,n)&&s(e,n,t[n]);return e},i=(e,r)=>t(e,n(r));import{C as c,c as d,a as u,b as p,q as m,R as h,u as g,d as E,e as S,f,B as y,W as v,I,g as x,h as b,F as w,S as P,T as j,M as R,A as C,H as O,i as k,j as D,k as A,P as N}from"./vendor.612c16e0.js";import"indexof";const z={API_KEY:"AIzaSyCjpnfBjVxfYjrbphlmrqg3kB-prqnF5XA",CLIENT_ID:"197694824591-4hojso5k0jbtoarde5im88csmuek1ndl.apps.googleusercontent.com",SCOPE:"https://www.googleapis.com/auth/spreadsheets",DISCOVERY_DOCS_ARRAY:"https://sheets.googleapis.com/$discovery/rest?version=v4".split(" "),GAPI_SRC:"https://apis.google.com/js/api.js"};async function M(e){try{console.log("======== Gapi prepare start ========"),await(document.getElementById("gapi")?Promise.resolve(!0):new Promise(((e,t)=>{const n=document.createElement("script");n.src=z.GAPI_SRC,n.id="gapi",n.async=!0,n.onload=()=>{e(!0)},n.onerror=()=>{t(!1)},document.body.appendChild(n)}))),console.log("import Gapi success"),await new Promise(((e,t)=>{gapi.load("client:auth2",(()=>{e(!0)}))})),console.log("load Gapi sucess"),await async function(){try{return await gapi.client.init({apiKey:z.API_KEY,clientId:z.CLIENT_ID,discoveryDocs:z.DISCOVERY_DOCS_ARRAY,scope:z.SCOPE})}catch(e){throw e}}(),console.log("init Gapi success"),console.log("======== Gapi prepare end ========");e(await gapi.auth2.getAuthInstance())}catch(t){console.log(t),console.log("======== Gapi prepare fail ========")}}const F=d({name:"authState",initialState:{isSignIn:!1},reducers:{setSigninState:(e,{payload:t})=>{console.log("state",e),console.log("reducer",t),e.isSignIn=t}}}),{setSigninState:$}=F.actions;var G=F.reducer;async function _(e,t,n=""){return await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:e,range:`${n}!${t}`})}const q=d({name:"spreadSheetState",initialState:{id:null,current:{sheetIndex:null},sheets:{},title:null},reducers:{setId:(e,{payload:t})=>{e.id=t},setSheets:(e,{payload:t})=>{for(const n of t)e.sheets[n.index]=n},setTitle:(e,{payload:t})=>{e.title=t},setCurrentIndex:(e,{payload:t})=>{e.current.sheetIndex=t},setSheetData:(e,{payload:t})=>{e.sheets[t.index]=o(o({},e.sheets[t.index]),t)}}}),{setId:U,setTitle:Y,setSheets:T,setCurrentIndex:B,setSheetData:V}=q.actions,Z=({properties:e})=>{const{sheetId:t,index:n,title:r}=e;return{sheetId:t,title:r,index:n,headerRange:null,headerFields:[],values:[[]]}},J=e=>async(t,n)=>{try{const n=await async function(e){try{return await gapi.client.sheets.spreadsheets.get({spreadsheetId:e,includeGridData:!1})}catch(t){return console.log("getSrpeadSheet"),console.log(t),Promise.reject(t)}}(e);console.log("fetchSpreadSheet"),console.log(n);const{result:r}=n;t(U(e)),t(Y(r.properties.title));const a=r.sheets.map(Z);return t(T(a)),!0}catch(r){return console.log("fetchSpreadSheet:error",r),Promise.reject(r)}};var K=q.reducer;const L=e=>e.spreadSheetState,H=({spreadSheetState:e})=>{const t=e.current.sheetIndex;return console.log("currentId",t),"number"!=typeof t?null:e.sheets[t]},Q=p({reducer:u({authState:G,spreadSheetState:K})});const W=m.div`
  height: 100%;
  box-sizing: border-box;
  display: grid;
  grid-template-rows: 10% auto ${e=>!1===e.footer?null:"minmax(10%, max-content)"};
  grid-template-columns: 1fr min(65ch, calc(100% - 48px)) 1fr;
  padding: 1em 0;
  row-gap: 1em;
  & > * {
    grid-column: 2;
  }
  align-items: center;
`,X=m.h1`
  text-align: center;
`,ee=m.div`
  overflow: hidden;
`;function te({header:e,children:t,footer:n}){const r="string"==typeof e?h.createElement(X,null," ",e," "):e;return h.createElement(W,{footer:n},h.createElement("div",null,r),h.createElement(ee,null,t),!1===n||h.createElement("div",null,n))}function ne(){const e=g();return[E((e=>e.authState.isSignIn)),async()=>{const t=await async function(){try{return(await gapi.auth2.getAuthInstance().signIn()).isSignedIn()}catch(e){return console.log(e),Promise.reject(!1)}}();console.log("userId",t),e($(t))},async()=>{const t=await async function(){try{const e=await gapi.auth2.getAuthInstance().signOut();return console.log(e),Promise.resolve(!0)}catch(e){return console.log(e),Promise.reject(!1)}}();e($(!t))}]}const re="spreadSheetUrl.update",ae=/docs\.google\.com\/spreadsheets\/d\/([\w\-]{40,})\//,le=e=>{const t=e.match(ae);return t?t[1]:null};function se(e,{type:t,payload:n}){switch(t){case re:return o(o({},e),n);default:throw new Error}}function oe(){const e=g(),[t,n]=c.exports.useReducer(se,{isDirty:!1,url:"",urlState:"noId"}),[r]=ne(),[a,l]=function(){const e=c.exports.useRef({});return[t=>{const n=e.current[t];return void 0===n?-1:n},(t,n)=>{e.current[t]=+n}]}();return{isDirty:t.isDirty,url:t.url,urlState:t.urlState,setUrl:e=>{let t;const r=le(e);if(r){const e=a(r);t=1===e?"validId":0===e?"invalidId":"unverifiedId"}else t="noId";n({type:re,payload:{url:e,urlState:t,isDirty:!0}})},verifyUrl:async()=>{if(!r)return;if("unverifiedId"!==t.urlState)return;const a=le(t.url);try{await e(J(a)),l(a,!0),n({type:re,payload:{urlState:"validId"}})}catch(s){return console.log("verify",s),l(a,!1),n({type:re,payload:{urlState:"invalidId",isDirty:!1}}),s}}}}const ie=m.h3``,ce=m.p`
  color: red;
`,de=m.div`
  display: grid;
  gap: 2em;
`;function ue(e){const t=S(),[n,s]=c.exports.useState(!1),{isDirty:i,url:d,urlState:u,setUrl:p,verifyUrl:m}=oe();!function(e,t){c.exports.useEffect((()=>{!function(e){const n=e.match(/[^\/].*/g);n&&t(n[0])}(e.pathname)}),[e])}(f(),p);const[g,E]=ne(),b={fetchSpreadSheet:async()=>{s(!0),await m(),s(!1)},signIn:()=>{E()},nextPage:()=>{t.push("/init")}},[w,...P]=(({isPending:e,urlState:t,isSignIn:n,url:r,isDirty:a})=>{const l={disabled:"noId"===t||"invalidId"===t,loading:e,children:"",handlerName:"signIn"},s={children:""};if(n)switch(l.handlerName="fetchSpreadSheet",t){case"noId":l.children=`已登入，輸入${a?"正確":""}試算表網址`,a&&(s.children="試算表網址格式錯誤");break;case"unverifiedId":l.children="已登入，點擊讀取表單";break;case"validId":l.children="讀取完畢😉點擊進行設定",l.handlerName="nextPage";break;case"invalidId":if(l.disabled=!0,!a){l.children="讀取失敗😔幫我重新輸入表單";break}l.children="重新輸入網址後，點擊讀取表單",s.children="試算表網址無效，請重新輸入網址";break;default:throw Error("UI state Error")}else l.handlerName="signIn","unverifiedId"===t&&(l.children="點擊登入後，讀取試算表"),"noId"===t&&a&&(l.children="輸入正確試算表網址後，點擊登入",l.disabled=!0,s.children="試算表網址格式錯誤"),"noId"!==t||a||(l.disabled=!0,l.children="輸入試算表網址後，點擊登入");return[l,s]})({isPending:n,isSignIn:g,urlState:u,url:d,isDirty:i}),j=w,{handlerName:R}=j,C=((e,t)=>{var n={};for(var s in e)a.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&r)for(var s of r(e))t.indexOf(s)<0&&l.call(e,s)&&(n[s]=e[s]);return n})(j,["handlerName"]),[O]=P,k=b[R];return h.createElement(te,{footer:h.createElement(y,o({type:"primary",onClick:k},C))},h.createElement(de,null,h.createElement(v,null,h.createElement(ie,null,"Google SpreadSheet")),h.createElement(v,null,h.createElement(I,{id:"url-input",value:d,placeholder:"輸入您的 Google sheet 網址以獲得 id",onChange:e=>{p(e)},disabled:n}),h.createElement(ce,o({},O)),h.createElement("p",null,"isDirty: ",i+""),h.createElement("p",null,"isSignIn: ",g+""),h.createElement("p",null,"isPending: ",n+""),h.createElement("p",null,"urlState: ",u+""),h.createElement("p",null,"isUrlEmpty123123: ",(""===d)+"")),h.createElement(x,{size:"xl"})))}const{Option:pe}=P,me=m.h3``,he=m.p`
  color: red;
`,ge=m.div`
  display: grid;
  gap: 2em;
`,Ee=m.div`
  display: grid;
  grid-template-columns: min-content auto;
  > a {
    padding: 0 1.5ch;
  }
  gap: 0.5em;
`,Se=e=>{const t={};return null===e.currentSheetIndex&&(t.currentSheetIndex="Requeired"),e.headerRange?e.headerRange.match(/[A-Z](\d*):[A-Z]\1$/gm)||(console.log("value error"),t.headerRange="invalid range"):t.headerRange="Requeired",console.log(e),t},fe=({data:e})=>h.createElement(j,{columns:[{title:"",dataIndex:"index",key:"index"},{title:"名稱",dataIndex:"fieldName",key:"fieldName"}],dataSource:e,showHeader:!1,pagination:!1});function ye(){const e=E(L),[t,n]=c.exports.useState([]),[r,a]=c.exports.useState(!1),l=function(){const e=S();return t=>{e.push(t)}}(),s=g(),d=Object.values(e.sheets).map((({title:e,index:t})=>h.createElement(pe,{value:t,key:t},e))),u=c.exports.useRef(null),p=()=>{var e;null==(e=u.current)||e.requestSubmit()},m=t.length>0?({currentSheetIndex:n,headerRange:r})=>{s(((e,t)=>async n=>{try{return n(B(e)),n(V(t)),Promise.resolve()}catch(r){return Promise.reject()}})(n,{index:n,headerRange:r,headerFields:t})).then((()=>{
//! 這個要怎麼辦...
l(`${e.id}/append`)}))}:async t=>{try{a(!0);const r=await _(e.id,t.headerRange,e.sheets[t.currentSheetIndex].title);n(r.result.values[0]),console.log(r.result.values[0])}catch(r){}finally{a(!1)}},f=t.map(((e,t)=>({key:`${t}_${e}`,index:t,fieldName:e})));return h.createElement(b,{onSubmit:m,validate:Se,render:({values:e,handleSubmit:a,form:l})=>{const s=!l.getState().valid;return console.log(s),h.createElement(te,{footer:h.createElement(Ee,null,t.length>0?h.createElement(y,{type:"ghost",onClick:()=>{l.restart(),n([])},disabled:0===t.length},"重新輸入 ⬅"):h.createElement("div",null),h.createElement(y,{type:"primary",onClick:p,loading:r,disabled:s},t.length>0?"設定完畢，GOGO 💨":"輸入完成，檢視欄位內容 💨"))},h.createElement("form",{onSubmit:a,ref:u},h.createElement(ge,null,0===t.length?h.createElement(h.Fragment,null,h.createElement("div",null,h.createElement(w,{name:"currentSheetIndex"},(({input:e,meta:t})=>h.createElement("div",null,h.createElement(me,null,"選擇表單"),h.createElement(P,o({placeholder:"Select a sheet",style:{width:"100%",fontSize:"17px"}},e),d),t.error&&h.createElement(he,null,t.error))))),h.createElement("div",null,h.createElement(w,{name:"headerRange"},(({input:e,meta:t})=>h.createElement("div",null,h.createElement(me,null,"表頭範圍"),h.createElement(I,i(o({},e),{placeholder:"A1:C1"})),t.error&&t.touched&&h.createElement(he,null,t.error)))))):h.createElement("div",null,h.createElement(me,null,"選定的欄位"),t.length>0?h.createElement(fe,{data:f}):"尚未選定欄位"))),h.createElement(v,null,h.createElement("br",null),h.createElement("br",null),h.createElement("br",null),"test",JSON.stringify(e)))}})}m.h1`
  text-align: center;
`;const ve=e=>null==e?void 0:e.map(((e,t)=>((e,t)=>h.createElement(w,{name:t,key:t,render:({meta:t,input:n})=>h.createElement("div",null,h.createElement(I,i(o({},n),{type:"text",placeholder:"start from left",clear:!0}),e),t.touched&&t.error&&h.createElement("span",null,t.error))}))(e,`${t}_${e}`))),Ie=({handleSubmit:e,form:t,children:n,setShowModal:r})=>{const a=c.exports.useRef(null);return h.createElement("form",{onSubmit:e,ref:a},h.createElement(te,{header:"Append",footer:h.createElement(v,{size:"lg"},h.createElement(y,{onClick:()=>{a.current&&a.current.requestSubmit(),console.log("123123"),t.reset(),r(!0),setTimeout((()=>{r(!1)}),1e3)},type:"primary"},"Submit"))},h.createElement("div",null,n)))};function xe({fields:e}){var t,n;const r=E(L),a=r.sheets[r.current.sheetIndex],l=null==(n=null==(t=a.headerRange)?void 0:t.match(/[a-zA-Z]/gm))?void 0:n.join(":"),s=ve(e),[d,u]=c.exports.useState(!1);return h.createElement(h.Fragment,null,h.createElement(R,{visible:d,transparent:!0,maskClosable:!1,onClose:()=>{u(!1)},title:"已送出",wrapProps:{onTouchStart:e=>{if(!/iPhone|iPod|iPad/i.test(navigator.userAgent))return;(function(e,t){const n=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;for(;e;){if(n.call(e,t))return e;e=e.parentElement}return null})(e.target,".am-modal-content")||e.preventDefault()}}}),h.createElement(b,{onSubmit:e=>{const t=Object.values(e);!async function({spreadsheetId:e,range:t,sheetId:n},r){await gapi.client.sheets.spreadsheets.values.append({spreadsheetId:e,valueInputOption:"USER_ENTERED",range:`${n}!${t}`},{majorDimension:"COLUMNS",values:r.map((e=>[e]))})}({spreadsheetId:r.id,range:l,sheetId:a.title},t)},validate:e=>({})},(e=>h.createElement(Ie,i(o({},e),{setShowModal:u}),s))))}function be(){const e=g(),t=E(L),[n]=ne();c.exports.useEffect((()=>{(async()=>{try{if(!n)throw Error("no login");await e((async(e,t)=>{try{const{spreadSheetState:n}=t(),r=n.sheets[n.current.sheetIndex],{result:a}=await _(n.id,"A:Z",r.title);e(V({index:r.index,values:a.values}))}catch(n){}}))}catch(t){}})()}),[t.current.sheetIndex,n])}const we=m.div``,Pe=({sheet:e})=>{const{headerRange:t}=e,n=+(null==t?void 0:t.split(":")[0].split("")[1]),r=e.headerFields.map(((e,t)=>({title:e,dataIndex:e,key:e,width:100}))),a=e.values.slice(n).reverse().map(((t,n)=>{const r=t.slice(0,e.headerFields.length),a={key:`${e.headerFields[n]}`};for(let l=0;l<e.headerFields.length;l++){const t=e.headerFields[l],n=r[l];a[t]=n?String(n):"empty"}return a}));return h.createElement(j,{columns:r,dataSource:a,scroll:{y:"65vh",x:"50px"},pagination:{position:["bottomCenter"],showSizeChanger:!1,pageSize:20}})};function je(){be();const e=E(H);return console.log(e),h.createElement(te,{header:"View",footer:!1},h.createElement(we,null,e&&h.createElement(Pe,{sheet:e})))}m(Pe)`
  .ant-table-cell {
    min
  }
`;const Re=m.div`
  display: grid;
  grid-template-rows: auto min-content;
  min-height: 100vh;
`,Ce=m.div`
  width: 100%;
  bottom: 0;
`;function Oe(e){var t;const[n,r]=c.exports.useState("append"),a=E(L),l=null==(t=a.sheets[a.current.sheetIndex])?void 0:t.headerFields,s={append:h.createElement(xe,{fields:l}),view:h.createElement(je,null)};return h.createElement(Re,null,s[n],h.createElement(Ce,null,h.createElement(C,null,h.createElement(C.Item,{icon:{uri:"https://zos.alipayobjects.com/rmsportal/asJMfBrNqpMMlVpeInPQ.svg"},selectedIcon:{uri:"https://zos.alipayobjects.com/rmsportal/gjpzzcrPMkhfEqgbYvmN.svg"},onPress:()=>{r("append")},title:"新增",key:"append",selected:"append"===n}),h.createElement(C.Item,{icon:{uri:"https://zos.alipayobjects.com/rmsportal/asJMfBrNqpMMlVpeInPQ.svg"},selectedIcon:{uri:"https://zos.alipayobjects.com/rmsportal/gjpzzcrPMkhfEqgbYvmN.svg"},onPress:()=>{r("view")},title:"檢視",key:"view",selected:"view"===n}))))}m.h1`
  text-align: center;
`;const ke=m.div`
  margin: 0 auto;
  height: 100vh;
  max-width: 500px;
`,De=({judger:e,to:t,children:n})=>{const r=S(),a="function"==typeof e?e():e;return c.exports.useEffect((()=>{console.log("useEffect"),a&&(console.log("redirect"),r.push(t))}),[r,e]),h.createElement(h.Fragment,null,a||n)};function Ae(){const{authState:e,spreadSheetState:t}=E((e=>e)),n=!e.isSignIn||!t.id,r=null===t.current.sheetIndex;return console.log("noCurrentSheetIndex",r),console.log("!authState.isSignIn",e.isSignIn),console.log("spreadSheetState.id",t.id),console.log("notSigninOrNoSrpeadSheetId",n),h.createElement(O,null,h.createElement(ke,null,h.createElement(k,null,h.createElement(D,{exact:!0,path:"/",render:e=>h.createElement(ue,o({},e))}),h.createElement(D,{path:"/init",render:e=>h.createElement(De,{judger:n,to:"/"},h.createElement(ye,null))}),h.createElement(De,{judger:n,to:"/"},h.createElement(D,{path:"/:spreadSheetId/:pageName",render:e=>h.createElement(Oe,o({},e))})),h.createElement(D,{path:"/:spreadSheetUrl",render:e=>h.createElement(ue,o({},e))}))))}const Ne=({children:e})=>{const t=g(),n=function(e){const[t,n]=c.exports.useState(!1);return c.exports.useEffect((()=>{M((t=>{n(!0),e(t.isSignedIn.get(),t),console.log("auth!!!",t.isSignedIn.get())}))}),[]),console.log(t?"gapi: prepare complete":"gapi: not prepare"),t}((e=>{t($(e))}));return h.createElement(h.Fragment,null,n?e:null)};A.render(h.createElement(h.StrictMode,null,h.createElement(N,{store:Q},h.createElement(Ne,null,h.createElement(Ae,null)))),document.getElementById("root"));
